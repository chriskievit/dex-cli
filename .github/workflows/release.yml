name: Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type (major, minor, patch)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Verify dependencies
        run: go mod verify

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v ./...

      - name: Get version
        id: version
        run: |
          # Determine version bump type (default to patch for automatic runs)
          BUMP_TYPE="${{ github.event.inputs.version_bump }}"
          if [ -z "$BUMP_TYPE" ]; then
            BUMP_TYPE="patch"
          fi
          echo "Version bump type: $BUMP_TYPE"
          
          # Get the latest tag, or start at v1.0.0 if no tags exist
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$latest_tag" ]; then
            # No tags exist, start with v1.0.0
            new_version="v1.0.0"
            echo "No existing tags found, starting with $new_version"
          else
            echo "Latest tag: $latest_tag"
            # Extract version numbers (remove 'v' prefix)
            version=${latest_tag#v}
            IFS='.' read -r major minor patch <<< "$version"
            
            # Ensure we have valid numbers (handle edge cases)
            major=${major:-1}
            minor=${minor:-0}
            patch=${patch:-0}
            
            # Increment version based on bump type
            case "$BUMP_TYPE" in
              major)
                major=$((major + 1))
                minor=0
                patch=0
                echo "Bumping major version"
                ;;
              minor)
                minor=$((minor + 1))
                patch=0
                echo "Bumping minor version"
                ;;
              patch|*)
                patch=$((patch + 1))
                echo "Bumping patch version"
                ;;
            esac
            
            new_version="v${major}.${minor}.${patch}"
          fi
          
          echo "New version: $new_version"
          echo "version=$new_version" >> $GITHUB_OUTPUT
          echo "tag=$new_version" >> $GITHUB_OUTPUT
          echo "version_number=${new_version#v}" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Build Linux binary
        run: |
          GOOS=linux GOARCH=amd64 go build -o dex-linux-amd64 .
          
      - name: Build macOS binary (Intel)
        run: |
          GOOS=darwin GOARCH=amd64 go build -o dex-darwin-amd64 .
          
      - name: Build macOS binary (Apple Silicon)
        run: |
          GOOS=darwin GOARCH=arm64 go build -o dex-darwin-arm64 .
          
      - name: Build Windows binary
        run: |
          GOOS=windows GOARCH=amd64 go build -o dex-windows-amd64.exe .

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Release ${{ steps.version.outputs.version }}
            
            **Version bump type**: ${{ steps.version.outputs.bump_type }}
            
            Automated release from commit: ${{ github.sha }}
            
            ### Downloads
            - **Linux (amd64)**: `dex-linux-amd64`
            - **macOS (Intel)**: `dex-darwin-amd64`
            - **macOS (Apple Silicon)**: `dex-darwin-arm64`
            - **Windows (amd64)**: `dex-windows-amd64.exe`
          files: |
            dex-linux-amd64
            dex-darwin-amd64
            dex-darwin-arm64
            dex-windows-amd64.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
